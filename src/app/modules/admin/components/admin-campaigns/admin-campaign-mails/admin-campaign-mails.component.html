<div>
  <div class="emailsStats">
    <div>
      <span class="number">{{ mailsToSend }}
        <span class="badge" data-badge="0"><i class="far fa-envelope"></i></span>
      </span>
      professionnels non contactés
    </div>
    <div>
      <span class="number">{{ firstMail }}
        <span class="badge" data-badge="1"><i class="far fa-envelope"></i></span>
      </span>
      premiers mails envoyés
    </div>
    <div>
      <span class="number">{{ secondMail }}
        <span class="badge" data-badge="2"><i class="far fa-envelope"></i></span>
      </span>
      mails de relance envoyés
    </div>
    <div>
      <span class="number">{{ lastMail }}
        <span class="badge" data-badge="3"><i class="far fa-envelope"></i></span>
      </span>
      derniers mails envoyés
    </div>
  </div>
  <div *ngIf="!stats.batches || !stats.batches.length">
    Pas de batch d'emails programmé pour l'instant...
  </div>
  <p *ngIf="!quizGenerated" class="text-center text-error">
    La quiz n'a pas été généré pour cette innovation, il doit y avoir un quiz avant de faire un envoi d'emails !
  </p>
  <div class="centered-buttons">
    <button (click)="testModal=true" class="btn btn-primary">
      Envoyer les mails de test
    </button>
    <button (click)="batchModal=true" class="btn btn-primary" [disabled] = "!readyAutoBatch" >
      Programmer un nouveau batch de mails
    </button>
    <label class="form-switch">
      <input type="checkbox" (change)="AutoBatch()" [ngModel]="campaign.autoBatch" [disabled] = "!readyAutoBatch" >
      <i class="form-icon"></i> Autobatch
    </label>
    <label class="form-switch">
      <input type="checkbox" (change)="setNuggets()" [ngModel]="campaign.nuggets" [disabled] = "!readyAutoBatch" >
      <i class="form-icon"></i>Méthode nuggets
    </label>
    <ul>
      <li *ngIf="!quizGenerated"> Quizz manquant </li>
      <li *ngIf="!innoReady"> Fiche manquante </li>
      <li *ngIf="!defaultWorkflow"> Template par défaut manquant</li>
      <li *ngIf="statusAB == '0'"> Vous n'avez pas utilisé le super A/B testing</li>
      <li *ngIf="statusAB == '1'"> Vous ne pouvez pas commencer si A/B testing non validé</li>
    </ul>
    <!--
    <button (click)="creerpro()" class="btn btn-primary">
      CreerDesPros Alea + Autobatch si actif
    </button>
    -->
  </div>
  <div class="card" *ngFor="let batch of stats.batches; let batchIndex = index">
    <div class="card-header">
      <div class="card-title h5">
        Batch de {{batch.size}} pros
          <span *ngIf="this.poubelle(batch)">
            <a class="c-hand" role="button" (click)="(removeOK(batch)) && $event.preventDefault()">
              <i class="fas fa-trash"></i>
            </a>
          </span>
          <span *ngIf="batch.nuggets">
            <i class="fas fa-crow"></i>
          </span>
          <span *ngIf="!batch.nuggets && batch.status === 0">
            <a class="c-hand" role="button" (click)="nuggetsBatch = batch">
              <i class="fas fa-plus-circle"></i>
            </a>
          </span>
        <label class="form-switch" style="float:right">
          <input type="checkbox" (change)="freezeStatus(batch)" [ngModel]="batch.active" >
          <i class="form-icon"></i>
        </label>
      </div>
      <div class="card-subtitle text-gray">créé {{ batch.created | date: dateformat }}</div>
      <div class="card-body-batch">
        <app-shared-table
          [data]="this.tableBatch(batchIndex)"
          [config]="config"
          (editRow)="editBatch($event, batch)">
        </app-shared-table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL : Création de batch de mails -->
<div class="modal" [ngClass]="{'active': batchModal}">
  <div class="modal-overlay" (click)="(batchModal = false) && $event.preventDefault()"></div>
  <div class="modal-container">
    <div class="modal-header">
      <button class="btn btn-clear float-right" (click)="(batchModal = false) && $event.preventDefault()"></button>
      <div class="modal-title h5">Programmer un nouveau batch de mails</div>
      <p>Le batch doit être programmé dans plus de 7 minutes, ou être envoyé immédiatement</p>
    </div>
    <div class="modal-body">
      <div class="form-group">
        Nombre de pros à contacter :
        <input type="number" [(ngModel)]="newBatch.size"/>
      </div>
      <div class="form-group">
        Jour d'envoi du premier mail :
        <input type="date" [(ngModel)]="dateMail"/>
      </div>
      <div class="form-group">
        Heure d'envoi du premier mail :
        <input type="time" [(ngModel)]="timeMail"/>
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="batchModal = false; createNewBatch(true)" class="btn btn-primary"
              [disabled]="!newBatch.size || (!!dateMail && !!timeMail)">
        Envoyer le batch immédiatement
      </button>
      <button class="btn btn-primary" (click)="batchModal = false; createNewBatch(false)"
              [disabled]="!newBatch.size || !dateMail || !timeMail">Créer</button>
      <button class="btn btn-link" (click)="(batchModal = false) && $event.preventDefault()">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL : Suppression du batch -->
<div class="modal" [ngClass]="{'active': selectedBatchToBeDeleted}"  >
  <div class="modal-overlay" (click)="(selectedBatchToBeDeleted = null) && $event.preventDefault()"></div>
  <div class="modal-container">
    <div class="modal-header">
      <button class="btn btn-clear float-right" (click)="(selectedBatchToBeDeleted = null) && $event.preventDefault()"></button>
      <div class="modal-title h5">Suppression d'un batch</div>
    </div>
    <div class="modal-body">
      <div class="content">Etes-vous bien sûr de vouloir supprimer ce magnifique batch ??</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-link" (click)="deleteBatch(selectedBatchToBeDeleted._id)">{{ 'COMMON.DELETE' | translate }}</button>
      <button class="btn btn-primary" (click)="(selectedBatchToBeDeleted = null) && $event.preventDefault()">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
    </div>
  </div>
</div>


<div class="modal" [ngClass]="{'active': testModal}">
  <div class="modal-overlay" (click)="(testModal = null) && $event.preventDefault()"></div>
  <div class="modal-container">
    <div class="modal-header">
      <button class="btn btn-clear float-right" (click)="(testModal = null) && $event.preventDefault()"></button>
      <div class="modal-title h5">Envoi des emails de test</div>
    </div>
    <div class="modal-body email-buttons">
      <button (click)="sendTestEmails(1)" class="btn btn-primary">
        Envoyer le premier mail à Karine
      </button>
      <button (click)="sendTestEmails(2)" class="btn btn-primary">
        Envoyer la première relance à Karine
      </button>
      <button (click)="sendTestEmails(3)" class="btn btn-primary">
        Envoyer la deuxième relance à Karine
      </button>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="(testModal = null) && $event.preventDefault()">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL : ajout de nuggets -->
<div class="modal" [ngClass]="{'active': nuggetsBatch}">
  <div class="modal-overlay" (click)="(nuggetsBatch = null) && $event.preventDefault()"></div>
  <div class="modal-container">
    <div class="modal-header">
      <button class="btn btn-clear float-right" (click)="(nuggetsBatch = null) && $event.preventDefault()"></button>
      <div class="modal-title h5">Ajout de pros 'nuggets'</div>
    </div>
    <div class="modal-body">
      <p *ngIf="nuggetsBatch">Êtes-vous sûr de vouloir ajouter {{this.Math.round(nuggetsBatch.size / 10)}} pros à 80% dans ce batch ?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="addNuggetsToBatch(nuggetsBatch._id)">Ajouter</button>
      <button class="btn btn-link" (click)="(nuggetsBatch = null) && $event.preventDefault()">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
    </div>
  </div>
</div>

  <app-sidebar
    [template]="templateSidebar" (closeSidebar)="closeSidebar($event)">
    <app-sidebar-batch
      [rowBatch]="currentRow"
      [content]="content"
      (batchChange)="onSubmitEditBatch($event)"
    >
    </app-sidebar-batch>
  </app-sidebar>

