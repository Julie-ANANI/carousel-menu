<div id="pitch">

  <!-- description edition -->
  <div class="main-wrapper is-description">
    <div class="content-wrapper">

      <!-- heading / sub heading -->
      <section class="text-center">
        <h1 class="title is-4 text-bold">{{ 'PROJECT_PITCH.DESCRIPTION.HEADING' | translate }}</h1>
        <h2 class="subtitle">{{ 'PROJECT_PITCH.DESCRIPTION.SUB_HEADING' | translate }}</h2>
      </section>
      <!-- /heading / sub heading -->

      <!-- action buttons -->
      <section
        *ngIf="innovation.status === 'EDITING'"
        class="flex-between m-bottom-20 action-btn-wrapper animate-fade is-5">

        <!-- proofreading -->
        <div [ngClass]="{'popover': !isRequesting && !isSaving && !isSubmitting}" class="m-right-15 m-bottom-15">

          <button
            (click)="onRequestProofreading($event)"
            [disabled]="isRequesting || isSaving || isSubmitting"
            [ngStyle]="{ 'min-height': '46px', 'min-width': '226px' }"
            class="button is-community is-sm is-outlined"
            id="btn-request">
            <ng-container *ngIf="!isRequesting; else defReqText">
              {{ 'COMMON.BUTTON.REQUEST_PROOFREADING' | translate }}
              <img
                alt=" "
                src="https://res.cloudinary.com/umi/image/upload/app/default-images/pictos/picto-bell-blue.svg"
                class="icon-right">
            </ng-container>
            <ng-template #defReqText>{{ 'COMMON.BUTTON.REQUESTING_PROOFREADING' | translate }}</ng-template>
          </button>

          <div *ngIf="!isRequesting && !isSaving && !isSubmitting" class="popover-container is-sm">
            <div class="card text-center">
              {{ 'PROJECT_PITCH.POPOVER.REQUEST_PROOFREADING' | translate }}
            </div>
          </div>

        </div>
        <!-- /proofreading -->

        <!-- validate -->
        <button
          (click)="onOpenModal($event)"
          [disabled]="isRequesting || isSaving || isSubmitting"
          [ngStyle]="{ 'min-height': '46px', 'min-width': '226px' }"
          class="button is-community is-sm m-bottom-15"
          id="btn-submit">
          {{ 'COMMON.BUTTON.VALIDATE_DEFINITIVELY' | translate }}
          <img
            alt=" "
            src="https://res.cloudinary.com/umi/image/upload/app/default-images/pictos/picto-validate-white.svg"
            class="icon-right">
        </button>
        <!-- /validate -->

      </section>
      <!-- /action buttons -->

      <!-- sections -->
      <section
        *ngFor="let section of sections; let i=index;"
        [ngStyle]="{ 'animation-duration': ((i+1) * 110) + 'ms' }"
        class="animate-slide slide-down">
        <div
          *ngIf="section.visibility"
          [ngClass]="{ 'is-filled': (section.content && section.content.length),
          'is-not-filled': !(section.content && section.content.length > 0),
          'is-active': activeSection === section.type, 'm-no-bottom': i === (sections.length-1) }"
          class="field-wrapper">

          <!-- header -->
          <div class="flex-between w-full">
            <div class="d-flex align-center m-right-1">
            <span class="m-right-2 field-heading">
              <ng-container *ngIf="section.type === 'ISSUE' || section.type === 'SOLUTION'; else defTitle">
                {{ section.title | InnovCardTitle:section.content:activeInnovCard.lang }}
              </ng-container>
              <ng-template #defTitle>{{ section.title }}</ng-template>
            </span>
              <span *ngIf="sectionCommentLabel(section.type)" class="label is-primary is-sm text-xs p-left-3 p-right-3">
              {{ 'COMMON.LABEL.COMMENT' | translate }} UMI
            </span>
            </div>
            <span (click)="openSidebar(section.type, section.content)" class="icon-container is-overlay">
            <img src="https://res.cloudinary.com/umi/image/upload/app/default-images/pictos/picto-edit.svg" alt="">
          </span>
          </div>
          <!-- /header -->

          <!-- content -->
          <div
            *ngIf="section.type !== 'MEDIA'"
            [ngStyle]="{'margin-bottom': section.type === 'SUMMARY' ? '-8px' : '0'}"
            [innerHTML]="section.content"
            class="text-sm p-top-h">
          </div>
          <!-- /content -->

          <!-- content for section === 'MEDIA' -->
          <div
            *ngIf="section.type === 'MEDIA'"
            [ngStyle]="{ 'margin-left': '-10px', 'margin-right': '-15px' }"
            class="m-top-10 d-flex flex-wrap">

            <!-- principal media -->
            <div
              *ngIf="activeInnovCard.principalMedia && mediaSrc(activeInnovCard.principalMedia)"
              class="text-center media-wrapper">
              <figure>
                <img
                  [src]="mediaSrc(activeInnovCard.principalMedia)"
                  alt=" "
                  class="img-responsive"
                  height="79.5"
                  width="120">
              </figure>
              <span class="text-xs p-top-1">{{ 'PROJECT_PITCH.DESCRIPTION.MAIN_MEDIA' | translate }}</span>
            </div>
            <!-- /principal media -->

            <!-- secondary medias -->
            <ng-container *ngIf="activeInnovCard.media && activeInnovCard.media.length > 0">
              <ng-container *ngFor="let media of activeInnovCard.media">
                <div
                  *ngIf="mediaSrc(media) &&
                  media._id !== (activeInnovCard.principalMedia && activeInnovCard.principalMedia._id)"
                  class="media-wrapper">
                  <figure>
                    <img
                      [src]="mediaSrc(media)"
                      alt=" "
                      class="img-responsive"
                      height="79.5"
                      width="120">
                  </figure>
                </div>
              </ng-container>
            </ng-container>
            <!-- /secondary medias -->

          </div>
          <!-- /content for section === 'MEDIA' -->

        </div>
      </section>
      <!-- /sections -->

    </div>
  </div>
  <!-- /description edition -->

  <!-- questionnaire -->
  <div class="main-wrapper is-questionnaire">
    <div class="content-wrapper animate-fade is-5">

      <!-- heading / sub heading -->
      <section class="text-center">
        <h1 class="title is-4 text-bold">{{ 'PROJECT_PITCH.QUESTIONNAIRE.HEADING' | translate }}</h1>
        <h2 class="subtitle">{{ 'PROJECT_PITCH.QUESTIONNAIRE.SUB_HEADING' | translate }}</h2>
      </section>
      <!-- /heading / sub heading -->

      <!-- preset -->
      <section
        *ngFor="let section of preset.sections; let i = index;"
        [ngClass]="{'p-top-20': i !== 0 }"
        class="preset-wrapper">

        <p *ngIf="section.label[activeInnovCard.lang]">
          SECTION {{ section.label[activeInnovCard.lang] | uppercase }}
        </p>

        <div
          *ngFor="let question of section.questions; let j = index;"
          [ngStyle]="{'margin-top': '18px', 'animation-duration': ((j+1) * 110) + 'ms'}"
          class="animate-slide slide-down">
          <div (click)="question.toggle = !question.toggle" class="d-flex align-center c-hand">
            <div class="icon-container is-overlay m-right-1 is-sm">
              <i [ngClass]="question.toggle ? 'icon-arrow-down' : 'icon-arrow-up'" class="icon"></i>
            </div>
            <span *ngIf="question.label[activeInnovCard.lang]">{{ question.label[activeInnovCard.lang] }}</span>
          </div>
          <div
            *ngIf="!question.toggle && (question.controlType === 'checkbox' || question.controlType === 'radio'
            || question.controlType === 'stars')"
               class="m-left-30 d-flex flex-wrap">
            <div *ngFor="let option of question.options" class="label">
              {{ option.label[activeInnovCard.lang] }}
            </div>
          </div>
        </div>

      </section>
      <!-- /preset -->

      <!-- comment box -->
      <section *ngIf="innovation.status !== 'DONE'" class="comment-wrapper text-center">

        <div class="divider"></div>

        <h3 class="text-sm text-normal m-bottom-10">{{ 'PROJECT_PITCH.QUESTIONNAIRE.MESSAGE_HEADING' | translate }}</h3>

        <div class="form-group m-bottom-15">
          <label>
            <textarea
              (keypress)="onChangeMessage($event)"
              [(ngModel)]="innovation.questionnaireComment"
              class="form-input is-shadowed"
              id="message"
              rows="3">
            </textarea>
          </label>
        </div>

        <div class="text-right">
          <button
            (click)="onSendMessage($event)"
            [disabled]="isSendingMessage || !newMessage || !innovation.questionnaireComment"
            class="button is-sm is-community"
            id="btn-send">
            <ng-container *ngIf="isSendingMessage; else defMsgText">
              {{ 'COMMON.BUTTON.SENDING_MESSAGE' | translate }}
            </ng-container>
            <ng-template #defMsgText>{{ 'COMMON.BUTTON.SEND_MESSAGE' | translate }}</ng-template>
          </button>
        </div>

      </section>
      <!-- /comment box -->

    </div>
  </div>
  <!-- /questionnaire -->

</div>


<!-- modal to confirm the submission -->
<app-utility-modal-empty [(showModal)]="showModal" [maxWidth]="'780px'">

  <!-- body -->
  <section class="modal-body">

    <h2 [ngSwitch]="{ 'color': '4C4C4C' }" class="title is-4 text-center text-bold">
      {{ 'PROJECT_PITCH.MODAL.HEADING_SUBMIT' | translate }}
    </h2>

    <div *ngIf="mission.externalDiffusion" class="mxw-650 authorise-wrapper form-group">
      <p>{{ 'PROJECT_PITCH.MODAL.SUBMIT_TEXT' | translate }}</p>
      <div *ngFor="let diffusion of authorisation">
        <label class="form-checkbox">
          <input
            (change)="onChangeAuthorisation($event, diffusion.toLowerCase())"
            [checked]="mission.externalDiffusion[diffusion.toLowerCase()]"
            [id]="diffusion.toLowerCase()"
            type="checkbox">
          <i class="form-icon"></i> {{ 'PROJECT_SETTINGS.' + diffusion | translate }}
        </label>
      </div>
    </div>

  </section>
  <!-- /body -->

  <!-- footer -->
  <footer class="modal-footer justify-center">

    <button
      (click)="onCloseModal()"
      [disabled]="isSubmitting"
      id="btn-cancel"
      class="button modal-cancel">
      {{ 'COMMON.BUTTON.CANCEL' | translate }}
    </button>

    <button
      [disabled]="isSubmitting"
      (click)="onSubmitProject($event)"
      class="button is-community"
      id="btn-confirm">
      <ng-container *ngIf="isSubmitting; else defSubText">
        {{ 'COMMON.BUTTON.VALIDATING_DEFINITIVELY' | translate }}
      </ng-container>
      <ng-template #defSubText>{{ 'COMMON.BUTTON.CONFIRM' | translate }}</ng-template>
    </button>

  </footer>
  <!-- /footer -->

</app-utility-modal-empty>
<!-- /modal to confirm the submission -->


<!-- sidebar to edit innovation card field -->
<app-sidebar [(template)]="sidebarValue">
  <app-sidebar-project-pitch
    (saveProject)="onSaveProject($event)"
    (tobeSavedChanges)="onChangesToBeSaved($event)"
    [(isSaving)]="isSaving"
    [cardContent]="cardContent"
    [comment]="operatorComment"
    [imagePostUri]="imagePostUri"
    [isEditable]="isEditable"
    [mainMedia]="activeInnovCard.principalMedia"
    [pitchHelp]="pitchHelp"
    [type]="sidebarValue.type">
  </app-sidebar-project-pitch>
</app-sidebar>
<!-- /sidebar to edit innovation card field -->
