<div id="pitch">

  <!-- description edition -->
  <div class="main-wrapper is-description">
    <div class="content-wrapper">

      <!-- heading / sub heading -->
      <section class="text-center">
        <h1 class="title is-4 text-bold">{{ 'PROJECT_PITCH.DESCRIPTION.HEADING' | translate }}</h1>
        <h2 class="subtitle">{{ 'PROJECT_PITCH.DESCRIPTION.SUB_HEADING' | translate }}</h2>
      </section>
      <!-- /heading / sub heading -->

      <!-- action buttons -->
      <section
        *ngIf="innovation.status === 'EDITING'"
        class="flex-between m-bottom-20 action-btn-wrapper animate-fade is-5">

        <!-- proofreading -->
        <div [ngClass]="{'popover': !isRequesting && !isSaving && !isSubmitting}" class="m-right-15 m-bottom-15">

          <button
            *ngIf="languageValidated() !== innoCardLanguages.length"
            (click)="onRequestProofreading($event)"
            [disabled]="isRequesting || isSaving || isSubmitting"
            style="min-width: 226px; min-height: 46px"
            class="button is-sm is-outlined"
            id="btn-request">
            <ng-container *ngIf="!isRequesting; else defReqText">
              {{ 'COMMON.BUTTON.REQUEST_PROOFREADING' | translate }}
              <img
                alt=" "
                src="https://res.cloudinary.com/umi/image/upload/app/default-images/pictos/picto-bell-blue.svg"
                class="icon-right">
            </ng-container>
            <ng-template #defReqText>{{ 'COMMON.BUTTON.REQUESTING_PROOFREADING' | translate }}</ng-template>
          </button>

          <div *ngIf="!isRequesting && !isSaving && !isSubmitting" class="popover-container is-sm">
            <div class="card text-center">
              {{ 'PROJECT_PITCH.POPOVER.REQUEST_PROOFREADING' | translate }}
            </div>
          </div>

        </div>
        <!-- /proofreading -->

        <!-- validate -->
        <button
          (click)="onOpenModal($event)"
          *ngIf="languageValidated() !== innoCardLanguages.length"
          [disabled]="isRequesting || isSaving || isSubmitting"
          style="min-width: 226px; min-height: 46px"
          class="button is-sm m-bottom-15"
          id="btn-submit">
          {{ 'COMMON.BUTTON.VALIDATE_DEFINITIVELY' | translate }} {{languageValidated()}}/{{innoCardLanguages.length}}
          <img
            alt=" "
            src="https://res.cloudinary.com/umi/image/upload/app/default-images/pictos/picto-validate-white.svg"
            class="icon-right">
        </button>
        <!-- /validate -->

      </section>
      <!-- /action buttons -->

      <!-- sections -->
      <section
        *ngFor="let section of sections; let i=index;"
        [ngStyle]="{ 'animation-duration': ((i+1) * 110) + 'ms' }"
        class="animate-slide slide-down">
        <div
          *ngIf="section.visibility"
          [ngClass]="{ 'is-filled': (section.content && section.content.length),
          'is-not-filled': !(section.content && section.content.length > 0),
          'is-active': activeSection.type === section.type && activeSectionIndex === i,
          'm-no-bottom': i === (sections.length-1) }"
          class="field-wrapper">

          <!-- header -->
          <div class="flex-between w-full">
            <div class="d-flex align-center m-right-1">
            <span class="m-right-2 field-heading">
              <ng-container
                *ngIf="section.type === 'ISSUE' || section.type === 'SOLUTION'
                || section.type === 'CONTEXT'; else defTitle">
                {{ section.title | InnovCardTitle:section.content:activeInnovCard.lang }}
              </ng-container>
              <ng-template #defTitle>{{ section.title }}</ng-template>
            </span>
              <span *ngIf="sectionCommentLabel(section.type, section.etherpadElementId) " class="label is-primary is-sm text-xs p-left-3 p-right-3">
                {{ 'COMMON.LABEL.COMMENTS' | translate }}
              </span>
            </div>
            <span (click)="openSidebar(section, i)" class="icon-container is-overlay">
            <img src="https://res.cloudinary.com/umi/image/upload/app/default-images/pictos/picto-edit.svg" alt="">
          </span>
          </div>
          <!-- /header -->

          <!-- content -->
          <div
            *ngIf="section.type !== 'MEDIA'"
            [ngStyle]="{'margin-bottom': section.type === 'SUMMARY' ? '-8px' : '0'}"
            [innerHTML]="section.content | cleanHtml"
            class="text-sm p-top-h">
          </div>
          <!-- /content -->

          <!-- content for section === 'MEDIA' -->
          <div
            *ngIf="section.type === 'MEDIA'"
            style="margin-left: -10px; margin-right: -15px"
            class="m-top-10 d-flex flex-wrap-wrap">

            <!-- principal media -->
            <div
              *ngIf="activeInnovCard.principalMedia && mediaSrc(activeInnovCard.principalMedia)"
              class="text-center media-wrapper">
              <figure>
                <img
                  [src]="mediaSrc(activeInnovCard.principalMedia)"
                  (click)="mediaToShow(mediaSrc(activeInnovCard.principalMedia))"
                  alt="NA"
                  style="cursor: pointer"
                  class="img-responsive"
                  height="79.5"
                  width="120">
              </figure>
              <span class="text-xs p-top-1">{{ 'PROJECT_PITCH.DESCRIPTION.MAIN_MEDIA' | translate }}</span>
            </div>
            <!-- /principal media -->

            <!-- secondary medias -->
            <ng-container *ngIf="activeInnovCard.media && activeInnovCard.media.length > 0">
              <ng-container *ngFor="let media of activeInnovCard.media">
                <div
                  *ngIf="mediaSrc(media) &&
                  media._id !== (activeInnovCard.principalMedia && activeInnovCard.principalMedia._id)"
                  class="media-wrapper">
                  <figure>
                    <img
                      style="cursor: pointer"
                      [src]="mediaSrc(media)"
                      (click)="mediaToShow(mediaSrc(media))"
                      alt="NA"
                      class="img-responsive"
                      height="79.5"
                      width="120">
                  </figure>
                </div>
              </ng-container>
            </ng-container>
            <!-- /secondary medias -->

          </div>
          <!-- /content for section === 'MEDIA' -->

        </div>
      </section>
      <!-- /sections -->

    </div>
  </div>
  <!-- /description edition -->

  <!-- questionnaire -->
  <div class="main-wrapper is-questionnaire">
    <div class="content-wrapper animate-fade is-5">

      <!-- heading / sub heading -->
      <section class="text-center">
        <h1 class="title is-4 text-bold">{{ 'PROJECT_PITCH.QUESTIONNAIRE.HEADING' | translate }}</h1>
        <h2 class="subtitle">{{ 'PROJECT_PITCH.QUESTIONNAIRE.SUB_HEADING' | translate }}</h2>
      </section>
      <!-- /heading / sub heading -->

      <!-- questionnaire template -->
      <ng-container *ngIf="mission | mission:'hasMissionTemplate'; else oldPreset">
        <section
          *ngFor="let section of mission.template.sections; let i = index;"
          [ngClass]="{'p-top-20': i !== 0 && section.type !== 'NOTHING' }"
          class="preset-wrapper">

          <p *ngIf="section.type !== 'NOTHING'">
            {{ (section | common:'entry':activeInnovCard.lang)?.name | uppercase }}
          </p>

          <ng-container *ngFor="let question of section.questions; let j = index;">
            <div
              [ngStyle]="{'animation-duration': ((j+1) * 110) + 'ms'}"
              class="animate-slide slide-down"
              style="margin-top: 18px;">
              <div (click)="question['toggle'] = !question['toggle']" class="d-flex align-center c-hand">
                <div class="icon-container is-overlay m-right-1 is-sm">
                  <i [ngClass]="question['toggle'] ? 'icon-arrow-up' : 'icon-arrow-down'" class="icon"></i>
                </div>
                <span>{{ (question | missionQuestion:'entry':activeInnovCard.lang)?.label }}</span>
              </div>
              <div
                *ngIf="!question['toggle'] && (question['controlType'] === 'checkbox'
                || question['controlType'] === 'radio' || question['controlType'] === 'stars'
                || question['controlType'] === 'ranking' || question['controlType'] === 'likert-scale')"
                class="m-left-30 d-flex flex-wrap-wrap">
                <div *ngFor="let option of question['options']" class="label">
                  {{ (option | common:'entry':activeInnovCard.lang)?.label }}
                </div>
              </div>
            </div>
          </ng-container>

        </section>
      </ng-container>
      <!-- /questionnaire template -->

      <!-- preset -->
      <ng-template #oldPreset>
        <section
          *ngFor="let section of preset.sections; let i = index;"
          [ngClass]="{'p-top-20': i !== 0 }"
          class="preset-wrapper">

          <ng-container *ngIf="section['entry'] && section['entry'].length; else noPresetSectionEntry">
            <ng-container *ngIf="section['entry'] | langEntry: 'label':activeInnovCard.lang:false">
              <p>SECTION {{ section['entry'] | langEntry: 'label':activeInnovCard.lang:false }}</p>
            </ng-container>
          </ng-container>
          <ng-template #noPresetSectionEntry>
            <ng-container *ngIf="section | langEntry: 'label':activeInnovCard.lang:false">
              <p>SECTION {{ section | langEntry: 'label':activeInnovCard.lang:false }}</p>
            </ng-container>
          </ng-template>

          <div
            *ngFor="let question of section.questions; let j = index;"
            [ngStyle]="{'animation-duration': ((j+1) * 110) + 'ms'}"
            class="animate-slide slide-down"
            style="margin-top: 18px">
            <div (click)="question.toggle = !question.toggle" class="d-flex align-center c-hand">
              <div class="icon-container is-overlay m-right-1 is-sm">
                <i [ngClass]="question.toggle ? 'icon-arrow-up' : 'icon-arrow-down'" class="icon"></i>
              </div>
              <span *ngIf="question.label[activeInnovCard.lang]">{{ question.label[activeInnovCard.lang] }}</span>
            </div>
            <div
              *ngIf="!question.toggle && (question.controlType === 'checkbox' || question.controlType === 'radio'
            || question.controlType === 'stars'  || question.controlType === 'ranking')"
              class="m-left-30 d-flex flex-wrap-wrap">
              <div *ngFor="let option of question.options" class="label">
                {{ option.label[activeInnovCard.lang] }}
              </div>
            </div>
          </div>

        </section>
      </ng-template>
      <!-- /preset -->

      <!-- comment box -->
      <section *ngIf="innovation.status !== 'DONE'" class="comment-wrapper text-center">

        <div class="divider"></div>

        <h3 class="text-sm text-normal m-bottom-10">{{ 'PROJECT_PITCH.QUESTIONNAIRE.MESSAGE_HEADING' | translate }}</h3>

        <div class="form-group m-bottom-15">
          <label>
            <textarea
              (keypress)="onChangeMessage($event)"
              [(ngModel)]="innovation.questionnaireComment"
              class="form-input is-shadowed"
              id="message"
              rows="3">
            </textarea>
          </label>
        </div>

        <div class="text-right">
          <button
            (click)="onSendMessage($event)"
            [disabled]="isSendingMessage || !newMessage || !innovation.questionnaireComment"
            class="button is-sm is-primary"
            id="btn-send">
            <ng-container *ngIf="isSendingMessage; else defMsgText">
              {{ 'COMMON.BUTTON.SENDING_MESSAGE' | translate }}
            </ng-container>
            <ng-template #defMsgText>{{ 'COMMON.BUTTON.SEND_MESSAGE' | translate }}</ng-template>
          </button>
        </div>

      </section>
      <!-- /comment box -->

    </div>
  </div>
  <!-- /questionnaire -->

</div>


<!-- modal to confirm the submission -->
<umius-modal [(showModal)]="showModal" maxWidth="780px">

  <!-- body -->
  <section class="modal-body">

    <h2 [ngSwitch]="{ 'color': '4C4C4C' }" class="title is-4 text-center text-bold">
      {{ 'PROJECT_PITCH.MODAL.HEADING_SUBMIT' | translate }}
    </h2>

    <div class="mxw-650 authorise-wrapper form-group">
      <p>{{ 'PROJECT_PITCH.MODAL.SUBMIT_TEXT' | translate }}</p>

      <div class="languages-selection">
        <div class="form-group">
            <label class="form-checkbox d-flex align-center">
              <input type="checkbox" [(ngModel)]="isSelectedAll">
              <i class="form-icon"></i> {{'COMMON.LABEL.SELECT_ALL' | translate}}
            </label>
        </div>
        <div class="form-group d-flex flex-wrap-wrap m-top-10">
          <ng-container *ngFor="let language of innoCardLanguages">
            <label class="form-checkbox d-flex align-center" style="width: 33%">
              <input type="checkbox"
                     [disabled]="language['status'] && language['status'] !== 'EDITING'"
                     [(ngModel)]="language['checked']"
                     (ngModelChange)="selectLanguage(language)">
              <i class="form-icon"></i> {{language.alias}}
            </label>
          </ng-container>
        </div>
      </div>

    </div>

  </section>
  <!-- /body -->

  <!-- footer -->
  <footer class="modal-footer justify-center">

    <button
      (click)="onCloseModal()"
      id="btn-cancel"
      class="button modal-cancel">
      {{ 'COMMON.BUTTON.CANCEL' | translate }}
    </button>

    <button
      (click)="onValidateLanguages($event)"
      class="button"
      id="btn-confirm">
      {{ 'COMMON.BUTTON.CONFIRM' | translate }}
    </button>

  </footer>
  <!-- /footer -->

</umius-modal>
<!-- /modal to confirm the submission -->


<!-- sidebar to edit innovation card field -->
<umius-sidebar-full *ngIf="activeSection.etherpadElementId" [(template)]="sidebarValue">
  <app-sidebar-project-pitch
    (saveProject)="onSaveProject($event)"
    (tobeSavedChanges)="onChangesToBeSaved($event)"
    [(isSaving)]="isSaving"
    [cardContent]="cardContent"
    [collaborativesComments]="currentSectionComments"
    [comment]="operatorComment"
    [imagePostUri]="imagePostUri"
    [innovationId]="innovation._id"
    [isEditable]="isEditable"
    [isUploadingVideo]="isUploadingVideo"
    [mainMedia]="activeInnovCard.principalMedia"
    [pitchHelp]="pitchHelp"
    [sectionId]="activeSection.etherpadElementId"
    [type]="sidebarValue.type">
  </app-sidebar-project-pitch>
</umius-sidebar-full>
<!-- /sidebar to edit innovation card field -->

<!-- modal to view image -->
<umius-modal [(showModal)]="modalMedia" [medias]="[selectedMedia]"></umius-modal>
<!-- /modal to view image-->
