<div [hidden]="!canAccess()" class="animate-fade is-5 relative" id="admin-project-storyboard">

  <!-- error message while fetching -->
  <div *ngIf="fetchingError && !isLoading" class="container fluid grid-2xl">
    <div class="column col-sm-12 col-11 col-mx-auto">
      <app-utility-message-error></app-utility-message-error>
    </div>
  </div>
  <!-- /error message while fetching -->

  <!-- no fetching error -->
  <div *ngIf="!fetchingError && !isLoading">

    <!-- banner to show last requested video status -->
    <app-utility-banner [(showBanner)]="showBanner" [background]="bannerBackground">
      {{ bannerVideo.lastMessage && bannerVideo.lastMessage.message }}
    </app-utility-banner>
    <!-- /banner to show last requested video status -->

    <!-- banner project message  -->
    <app-utility-banner [(showBanner)]="showBannerUpdate" [position]="'relative'">
      This project has been updated by {{ showBannerUpdate }} at {{ updateTime | date: 'H:mm' }}
    </app-utility-banner>
    <!-- banner project message  -->

    <div class="container fluid grid-2xl p-top-30 p-bottom-40">
      <div class="column col-sm-12 col-11 col-mx-auto">

        <!-- header section -->
        <section class="header-wrapper d-flex flex-wrap">

          <!-- lang -->
          <div class="content-wrapper p-right-10 p-bottom-30">

            <!-- autofill / change lang -->
            <div
              *ngIf="executiveReport.lang && (canAccess(['autofill']) || canAccess(['changeLang']))"
              class="text-md">

              <div *ngIf="canAccess(['autofill'])">
                {{ 'ADMIN_STORYBOARD.AUTOFILL.A' | translate }}
                <span (click)="autofillExecutiveReport($event)" class="text-link text-normal">
                  {{ 'ADMIN_STORYBOARD.AUTOFILL.B' | translate }}</span> {{ 'ADMIN_STORYBOARD.AUTOFILL.C' | translate }}
              </div>

              <div *ngIf="canAccess(['changeLang'])">
                {{ 'ADMIN_STORYBOARD.CHANGE_LANG.A' | translate }}
                <span (click)="openLangModal($event, 'RESET')" class="text-link text-normal">
                  {{ 'ADMIN_STORYBOARD.CHANGE_LANG.B' | translate }}</span>{{ 'ADMIN_STORYBOARD.CHANGE_LANG.C' | translate }}
              </div>

            </div>
            <!-- /autofill / change lang -->

            <!-- select lang -->
            <div *ngIf="!executiveReport.lang && canAccess(['create'])" class="text-md">
              {{ 'ADMIN_STORYBOARD.SELECT_LANG.A' | translate }}
              <span (click)="openLangModal($event, 'CREATE')" class="text-link text-normal">
                {{ 'ADMIN_STORYBOARD.SELECT_LANG.B' | translate }}</span> {{ 'ADMIN_STORYBOARD.SELECT_LANG.C' | translate }}
            </div>
            <!-- /select lang -->

          </div>
          <!-- /lang -->

          <!-- buttons / links -->
          <div
            *ngIf="executiveReport.lang && (canAccess(['generateVideo']) || canAccess(['generatePdf'])
            || canAccess(['makeVisibleToClient']))"
            class="content-wrapper p-bottom-15">

            <!-- video -->
            <div *ngIf="canAccess(['generateVideo'])" class="video-wrapper">

              <!-- link -->
              <!--<div class="text-sm m-right-15 m-bottom-15">

                &lt;!&ndash; last generated date and time &ndash;&gt;
                <p>
                  {{ 'ADMIN_STORYBOARD.LAST_GENERATE' | translate }} 01/02/20 {{ 'ADMIN_STORYBOARD.AT' | translate }} 12:14
                </p>

                &lt;!&ndash; video url &ndash;&gt;
                <p [ngStyle]="{ 'white-space': 'nowrap' }" class="text-bold">
                  https://vimeo.com/387669379/02494b7130
                  <span class="tooltip" [attr.data-tooltip]="'COMMON.TOOLTIP.COPY' | translate">
                    <i (click)="copyLink($event, 'https://vimeo.com/387669379/02494b7130')"
                       class="icon icon-copy">
                    </i>
                  </span>
                </p>

              </div>-->
              <!-- /link -->

              <div class="popover m-bottom-15">

                <button
                  [disabled]="isVideoDisabled"
                  (click)="openVideoModal($event)"
                  class="button is-primary">
                  {{ 'COMMON.BUTTON.GENERATE_VIDEO' | translate }}
                </button>

                <div *ngIf="isVideoDisabled" class="popover-container is-sm">
                  <div class="p-top-20 text-center p-bottom-20 p-left-25 p-right-25">
                    Either report is incomplete or it is not able to download at the client side.
                  </div>
                </div>

              </div>

            </div>
            <!-- /video -->

            <!-- pdf -->
            <div *ngIf="canAccess(['makeVisibleToClient']) || canAccess(['generatePdf'])" class="pdf-wrapper">

              <!-- link -->
              <div
                *ngIf="canAccess(['makeVisibleToClient'])"
                [ngClass]="{'m-right-15': canAccess(['generatePdf'])}"
                class="text-sm form-group m-bottom-15">
                <label class="form-switch">
                  <input
                    (change)="onChangeDiffusion($event)"
                    [checked]="executiveReport.externalDiffusion"
                    id="externalDiffusion"
                    type="checkbox">
                  <i class="form-icon"></i> Available at Client side to download
                </label>
              </div>
              <!-- /link -->

              <button
                *ngIf="canAccess(['generatePdf'])"
                [disabled]="isGeneratingReport || executiveReport.completion.rate !== 100"
                (click)="generatePdf($event)"
                class="button is-primary is-outlined m-bottom-15">
                <ng-container *ngIf="!isGeneratingReport; else genCSV">
                  {{ 'COMMON.BUTTON.GENERATE_PDF' | translate }}
                </ng-container>
                <ng-template #genCSV>
                  {{ 'COMMON.BUTTON.GENERATING_FILE' | translate }}
                </ng-template>
              </button>
              <div class="popover text-error text-sm" *ngIf="executiveReport.completion.missingFields.length || !hasPrincipalMedia">
                <i class="fas fa-exclamation-triangle"></i>
                {{ 'ADMIN_STORYBOARD.MISSING_FIELDS.INTRO' | translate }}
                <div class="popover-container">
                  <div class="card">
                    <span *ngIf="!hasPrincipalMedia">
                      {{ 'ADMIN_STORYBOARD.MISSING_FIELDS.MEDIA' | translate }}
                     </span>
                    <span *ngFor="let field of executiveReport.completion.missingFields">
                      {{ 'ADMIN_STORYBOARD.MISSING_FIELDS.' + field.toUpperCase() | translate }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <!-- /pdf -->

          </div>
          <!-- /buttons / links -->

        </section>
        <!-- /header section -->

        <!-- charging report -->
        <div *ngIf="isChargingReport" class="text-center">
          <div class="loading is-primary is-md"></div>
        </div>
        <!-- /charging report -->

        <!-- executive report section -->
        <section *ngIf="executiveReport.lang && !isChargingReport" class="p-top-50">
          <app-admin-executive-report
            [executiveReport]="executiveReport"
            (executiveReportUpdate)="updateReport($event)"
            [isEditable]="canAccess(['edit'])">
          </app-admin-executive-report>
        </section>
        <!-- /executive report section -->

        <!-- save button -->
        <div *ngIf="toBeSaved && executiveReport.lang && canAccess(['edit'])" class="btn-save-float-wrapper">
          <button
            (click)="saveExecutiveReport($event)"
            class="button is-primary animate-zoom is-3 is-rounded">
            {{ 'COMMON.BUTTON.SAVE' | translate }}
          </button>
        </div>
        <!-- /save button -->

      </div>
    </div>

  </div>
  <!-- /no fetching error -->

</div>


<!-- modal to select/change language -->
<app-utility-modal
  *ngIf="canAccess(['changeLang']) || canAccess(['create'])"
  [(showModal)]="isModalLang"
  [title]="modalTitle | translate">
  <ng-container *ngIf="!isLoading && isModalLang">

    <section [ngClass]="executiveReport.lang ? 'p-top-30 p-bottom-10' : 'p-top-40'" class="modal-body">

      <div *ngIf="executiveReport.lang" class="m-bottom-15 text-background">
        {{ 'ADMIN_STORYBOARD.MODAL.CURRENT_LANG' | translate }}
        <span *ngIf="executiveReport.lang === 'en'" class="text-medium text-primary-dark">
        {{ 'COMMON.LANG.EN' | translate }}
      </span>
        <span *ngIf="executiveReport.lang === 'fr'" class="text-medium text-primary-dark">
        {{ 'COMMON.LANG.FR' | translate }}
      </span>
      </div>

      <div class="form-group d-flex justify-center m-no-bottom">

        <label class="form-radio is-inline">
          <input
            (change)="setNewSelectedLang('en')"
            [checked]="selectedLang === 'en'"
            id="lang-en"
            name="lang"
            type="radio"
            value="en">
          <i class="form-icon"></i> {{ 'COMMON.LANG.EN' | translate }}
        </label>

        <label class="form-radio is-inline">
          <input
            (change)="setNewSelectedLang('fr')"
            [checked]="selectedLang === 'fr'"
            id="lang-fr"
            name="lang"
            type="radio"
            value="fr">
          <i class="form-icon"></i> {{ 'COMMON.LANG.FR' | translate }}
        </label>

      </div>

      <div *ngIf="executiveReport.lang" class="m-top-30 text-sm">
        <span class="text-alert text-medium">{{ 'ADMIN_STORYBOARD.MODAL.ATTENTION' | translate }}</span>
        {{ 'ADMIN_STORYBOARD.MODAL.ATTENTION_MSG' | translate }}
      </div>

    </section>

    <footer class="modal-footer">
      <button class="button modal-cancel">{{ 'COMMON.BUTTON.CANCEL' | translate }}</button>
      <button (click)="onClickConfirm($event)" class="button is-primary">
        {{ 'COMMON.BUTTON.CONFIRM' | translate }}
      </button>
    </footer>

  </ng-container>
</app-utility-modal>
<!-- /modal to select/change language -->


<!-- modal to select type of video -->
<app-utility-modal-empty *ngIf="canAccess(['generateVideo'])" [(showModal)]="isModalVideo">
  <ng-container *ngIf="isModalVideo && !isLoading">

    <!-- body -->
    <section class="modal-body p-bottom-40">

      <!-- heading -->
      <h2 class="title is-4 text-center m-bottom-30 text-bold">
        {{ 'COMMON.MODAL.TITLE_VIDEO_STORYBOARD' | translate }}
      </h2>
      <!-- /heading -->

      <div class="flex-centered form-group p-top-20">
        <label class="form-radio is-inline">
          <input
            [disabled]="isGeneratingVideo || videoJobs.length >= 1"
            (change)="setVideo($event, 'VIDEO_TEST')"
            checked
            type="radio"
            name="video"
            id="video-test">
          <i class="form-icon"></i> {{ 'ADMIN_STORYBOARD.VIDEO_TYPE.TEST' | translate }}
        </label>
        <label class="form-radio is-inline">
          <input
            [disabled]="isGeneratingVideo || videoJobs.length <= 1"
            (change)="setVideo($event, 'VIDEO_FINAL')"
            type="radio"
            name="video"
            id="video-final">
          <i class="form-icon"></i> {{ 'ADMIN_STORYBOARD.VIDEO_TYPE.FINAL' | translate }}
        </label>
      </div>

    </section>
    <!-- /body -->

    <!-- footer -->
    <footer class="modal-footer justify-center">

      <button
        (click)="closeModal()"
        [id]="'btn-cancel'"
        class="button modal-cancel">
        {{ 'COMMON.BUTTON.CANCEL' | translate }}
      </button>

      <button
        [disabled]="isGeneratingVideo"
        (click)="generateVideo($event)"
        class="button is-community"
        id="btn-continue">
        <ng-container *ngIf="!isGeneratingVideo; else genVideo">
          {{ 'COMMON.BUTTON.GENERATE' | translate }}
        </ng-container>
        <ng-template #genVideo>
          {{ 'COMMON.BUTTON.GENERATING_VIDEO' | translate }}
        </ng-template>
      </button>

    </footer>
    <!-- /footer -->

  </ng-container>
</app-utility-modal-empty>
<!-- /modal to select type of video -->
