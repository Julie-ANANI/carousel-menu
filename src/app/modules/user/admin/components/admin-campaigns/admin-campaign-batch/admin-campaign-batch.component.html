<app-admin-stats-banner
  (updateStats)="loadStats()"
  [updateBtn]="true"
  [config]="statsConfig">
</app-admin-stats-banner>

<div class="container grid-2xl fluid" id="admin-campaign-batch">
  <div class="column col-sm-12 col-11 col-mx-auto">

    <!--<button (click)="createPro()" class="btn btn-primary">CreerDesPros Alea + Autobatch si actif</button>-->

    <!-- section no batches -->
    <section *ngIf="!batchesTable.length && !isLoading" class="p-top-30 p-bottom-30">

      <!-- note -->
      <div class="p-bottom-40 flex-centered">
        <div class="d-flex align-center">
          <div [ngClass]="innovationStatus ? 'bg-success' : 'bg-alert'" class="shape is-circled is-sm text-white">
            <i [ngClass]="innovationStatus ? 'fa-check' : 'fa-times'" class="fas"></i>
          </div>
          <span class="text-medium text-draft text-md m-left-1 m-right-20">Project validation</span>
        </div>
        <div class="d-flex align-center">
          <div [ngClass]="quiz ? 'bg-success' : 'bg-alert'" class="shape is-circled is-sm text-white">
            <i [ngClass]="quiz ? 'fa-check' : 'fa-times'" class="fas"></i>
          </div>
          <span class="text-medium text-draft text-md m-left-1 m-right-20">Quiz</span>
        </div>
        <div class="d-flex align-center">
          <div [ngClass]="templatesStatus ? 'bg-success' : 'bg-alert'" class="shape is-circled is-sm text-white">
            <i [ngClass]="templatesStatus ? 'fa-check' : 'fa-times'" class="fas"></i>
          </div>
          <span class="text-medium text-draft text-md m-left-1 m-right-20">Workflows</span>
        </div>
      </div>
      <!-- /note -->

      <!-- bot -->
      <ng-container *ngIf="autoBatchStatus && (canAccess(['autoBatch']) || canAccess(['create']))">
        <app-message-template widthMax="473px">

          <div class="d-flex justify-center">
            <div class="form-group relative m-no-bottom">
              <label class="form-switch" for="auto-batch">
                <input
                  (change)="onSwitchAutoBatch($event)"
                  [disabled]="!canAccess(['autoBatch']) || !autoBatchStatus"
                  [ngModel]="campaign.autoBatch"
                  [value]="campaign.autoBatch"
                  id="auto-batch"
                  type="checkbox">
                <i class="form-icon"></i> Schedule emails automatically and take a holiday :)
              </label>
            </div>
          </div>

          <!-- new batch -->
          <ng-container *ngIf="canAccess(['create'])">
            <button
              (click)="activateSidebar('NEW_BATCH')"
              class="button is-outlined is-sm is-white m-top-20"
              id="btn-manually">
              Schedule emails manually
            </button>
          </ng-container>
          <!-- /new batch -->

        </app-message-template>
      </ng-container>
      <!-- /bot -->

    </section>
    <!-- /section no batches -->

    <!-- section batches -->
    <div *ngIf="batchesTable.length && !isLoading" class="p-top-30 p-bottom-30">

      <!-- autobatch / new batch -->
      <section
        *ngIf="canAccess(['autoBatch']) || canAccess(['create'])"
        [ngClass]="{'text-right': !canAccess(['autoBatch']),
        'flex-between': canAccess(['autoBatch']) && canAccess(['create']) }"
        class="m-bottom-10">

        <!-- autobatch / to send -->
        <div class="d-flex align-center m-bottom-15 m-right-25">

          <div *ngIf="canAccess(['autoBatch'])" class="form-group m-right-30">
            <label class="form-switch text-medium text-meta" for="result-auto-batch">
              <input
                (change)="onSwitchAutoBatch($event)"
                [ngModel]="campaign.autoBatch"
                id="result-auto-batch"
                type="checkbox">
              <i class="form-icon"></i>{{campaign.autoBatch ? 'Auto-batch activated' :
              'Auto-batch deactivated'}}
            </label>
          </div>

          <div class="m-bottom-2 text-sm text-medium">
            To send: {{ toSend() }}
          </div>

        </div>
        <!-- /autobatch / to send -->

      </section>
      <!-- /autobatch / new batch -->

      <!-- batches -->
      <section
        *ngFor="let batch of batches['batches'];
        let batchIndex = index;"
        [ngStyle]="{ 'animation-duration': ((batchIndex + 1) * 200) + 'ms' }"
        class="card animate-slide slide-down">

        <div class="card-header">

          <div class="card-title">
            <span class="m-right-2">Batch for {{ batch.size }} pros - {{ batch.type }}</span>
            <span *ngIf="batch?.childBatch.length > 1" class="m-right-2"> ({{batch?.childBatch.length * 5 - 5}} minutes to send)</span>
            <span *ngIf="batch.error" class="text-error m-right-2 m-top-1 text-xs text-normal">
              There has been an error while sending this batch!
            </span>
            <div
              (click)="onDeleteBatch($event, batch)"
              *ngIf="getDeleteStatus(batch) && canAccess(['delete'])"
              class="icon-container is-overlay">
              <span data-tooltip="Delete batch" class="tooltip">
                <img
                  src="https://res.cloudinary.com/umi/image/upload/app/default-images/pictos/picto-delete-danger.svg"
                  alt="">
              </span>
            </div>
          </div>

          <!-- switch - pause-activated -->
          <label
            *ngIf="canAccess(['pause'])"
            class="form-switch float-right text-medium p-no-top"
            [for]="batch['_id']">
            <input
              (change)="OnSwitchFreeze($event, batch)"
              [id]="batch['_id']"
              [ngModel]="batch.active"
              type="checkbox">
            <i class="form-icon"></i>
            <span *ngIf="!batch.active" class="tooltip"
                  [attr.data-tooltip]="'Sending is paused,\n'+'no email will be sent.'">Paused</span>
            <span *ngIf="batch.active" class="tooltip"
                  [attr.data-tooltip]="'Sending is activated,\n'+'email will be sent.'">Activated</span>
          </label>
          <!-- /switch - pause-activated -->

        </div>

        <div class="card-body">

          <!-- languages status -->
          <div class="languages-status-sections d-flex flex-wrap-wrap m-bottom-10" *ngIf="batch.languages && batch.languages.length">
            <ng-container *ngFor="let language of innovationCardLanguages">
              <ng-container *ngIf="containsLanguages(language.type, batch.languages)">
                <div
                  [ngClass]="isReady(language) ? 'bg-success' : 'bg-alert'"
                  class="shape is-circled is-sm text-white m-left-2">
                  <i [ngClass]="isReady(language) ? 'fa-check' : 'fa-times'" class="fas"></i>
                </div>

                <div class="m-left-1 text-medium">
                  <div [ngClass]="{'popover is-top': !isReady(language)}">
                    <div>{{('COMMON.LANG.' + language?.type?.toUpperCase()) | translate}}</div>
                    <div *ngIf="!isReady(language)" class="popover-container is-sm">
                      <div class="card d-flex flex-d-column align-flex-start bg-white">
                        <label class="m-bottom-1">Tasks remaining to validate this language:</label>
                        <label class="d-flex align-center m-top-3">
                          <i [ngClass]="language['status'] !== 'DONE'? 'fa fa-times-circle text-error': 'fa fa-check-circle text-success'"
                             class="m-right-2"></i>
                          Project to be validated
                        </label>
                        <label class="d-flex align-center m-top-3">
                          <i class=" m-right-2" [ngClass]="!isWorkflowReady(language)? 'fa fa-times-circle text-error': 'fa fa-check-circle text-success'"></i>
                          Workflows to be saved
                        </label>
                        <label class="d-flex align-center m-top-3">
                          <i class="m-right-2" [ngClass]="!innovation.quizId? 'fa fa-times-circle text-error': 'fa fa-check-circle text-success'"></i>
                          Quiz link to be generated
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-container>
          </div>
          <!-- /languages status -->

          <umius-table
            (editRow)="onClickEdit($event, batch)"
            [config]="localConfig"
            (performAction)="_updateBatch($event, batch)"
            [data]="getBatch(batchIndex)">
          </umius-table>
        </div>

      </section>
      <!-- /batches -->

      <!-- new batch -->
      <button
        (click)="activateSidebar('NEW_BATCH')"
        *ngIf="canAccess(['create'])"
        class="button is-primary is-sm centered"
        id="btn-new-batch">
        New batch
      </button>
      <!-- /new batch -->

    </div>
    <!-- /section batches -->

  </div>
</div>


<!-- modal to delete batch -->
<umius-modal
  *ngIf="canAccess(['delete'])"
  [(showModal)]="modalDelete"
  [title]="'Delete Board'">
  <ng-container *ngIf="selectedBatchToBeDeleted._id">

    <section class="modal-body">
      Do you really want to delete this batch?
    </section>

    <footer class="modal-footer">

      <button class="button modal-cancel" id="btn-cancel">Cancel</button>

      <button
        (click)="onConfirmDelete($event)"
        [disabled]="!selectedBatchToBeDeleted._id || isDeletingBatch"
        class="button is-primary"
        id="btn-confirm">
        <ng-container *ngIf="isDeletingBatch; else textDef">
          deleting the batch...
        </ng-container>
        <ng-template #textDef>
          Confirm
        </ng-template>
      </button>

    </footer>

  </ng-container>
</umius-modal>
<!-- /modal to delete batch -->


<!-- sidebars to perform batch operations -->
<umius-sidebar-full *ngIf="canAccess()" [(template)]="sidebarValue">
  <app-sidebar-batch
    (batchOutput)="onSidebarOutput($event)"
    [isEditable]="isEditable"
    [campaignWorkflows]="campaignWorkflows"
    [content]="content"
    [currentRow]="currentRow"
    [sidebarState]="sidebarValue.animate_state"
    [templateType]="sidebarValue.type"
    [workflow]="currentBatch?.workflow || (campaign.settings && campaign.settings.defaultWorkflow)">
  </app-sidebar-batch>
</umius-sidebar-full>
<!-- /sidebars to perform batch operations  -->

