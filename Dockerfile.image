FROM node:12.22-alpine AS baseimage

ARG APP_NAME
ARG ENV_NAME
ARG VERSION

RUN echo "!!!!!! Building front@${VERSION} with 'ng build ${APP_NAME} -c=${ENV_NAME}' !!!!!!"

WORKDIR /var/web

# Update this image
RUN apk update
RUN apk add gzip

# Install npm packages
RUN npm install -g @angular/cli@9.1.15
RUN npm install -g typings
RUN npm install pm2 -g

ADD package.json /var/web/package.json
ADD .npmrc /var/web/.npmrc
RUN npm config set loglevel warn
RUN npm install


# Remove NPM security file
RUN rm -f /var/web/.npmrc

ADD src /var/web/src
ADD assets /var/web/assets
ADD server.ts /var/web/server.ts
ADD angular.json /var/web/angular.json
ADD tsconfig.* /var/web/
ADD webpack.server.config.js /var/web/webpack.server.config.js
ADD cleanup.sh /var/web/cleanup.sh



# update version
RUN if [ $VERSION ]; then sed -i -e "s/latest/$VERSION/g" src/environments/version.ts; fi
